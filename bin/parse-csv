;; ~*~ clojure ~*~

(import '[java.io FileInputStream]
        '[org.zeromq SocketType ZMQ ZContext]
        '[org.antlr.v4.runtime CommonTokenFactory UnbufferedCharStream UnbufferedTokenStream]
        '[sentient CSVStreamLexer CSVStreamParser])

(let [[_ csv-path] *command-line-args*
      input-stream (FileInputStream. csv-path)
      input (UnbufferedCharStream. input-stream)
      lexer (doto (CSVStreamLexer. input)
              (.setTokenFactory (CommonTokenFactory. true)))
      tokens (UnbufferedTokenStream. lexer)
      parser (doto (CSVStreamParser. tokens)
               (.setBuildParseTree false))]
  (with-open [context (ZContext.)]
    (with-open [outgoing (.createSocket context SocketType/PUSH)]
      (.bind outgoing "tcp://127.0.0.1:5555")
      (with-open [incoming (.createSocket context SocketType/PULL)]
        (.connect incoming "tcp://127.0.0.1:5556")
        (doto parser
          (.outgoing outgoing)
          (.incoming incoming))
        (.csvFile parser)))))
