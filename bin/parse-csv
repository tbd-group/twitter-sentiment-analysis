;; ~*~ clojure ~*~

(import '[java.io FileInputStream]
        '[org.zeromq SocketType ZMQ ZContext]
        '[org.antlr.v4.runtime CommonTokenFactory UnbufferedCharStream UnbufferedTokenStream]
        '[sentient CSVStreamLexer CSVStreamParser])

(let [[_ csv-path] *command-line-args*
      input-stream (FileInputStream. csv-path)
      input (UnbufferedCharStream. input-stream)
      lexer (doto (CSVStreamLexer. input)
              (.setTokenFactory (CommonTokenFactory. true)))
      tokens (UnbufferedTokenStream. lexer)
      parser (doto (CSVStreamParser. tokens)
               (.setBuildParseTree false))]
  (with-open [context (ZContext.)]
    (with-open [output-socket (.createSocket context SocketType/PUSH)]
      (.bind output-socket "tcp://127.0.0.1:5555")
      (with-open [input-socket (.createSocket context SocketType/PULL)]
        (.connect input-socket "tcp://127.0.0.1:5556")
        (doto parser
          (.outputSocket output-socket)
          (.inputSocket input-socket))
        (.csvFile parser)))))
